# スクロール検知実装の比較

## 調査目的
利用規約のPDFまたはWebView表示において、ユーザーが最後まで読んだかを検知する機能の実装方法を調査する。

## 調査結果

### 1. PDF Preview (printing package)

#### 実装方法
- `NotificationListener<ScrollNotification>`を使用してスクロールイベントを監視
- スクロール位置が最大スクロール量に達したかを判定

#### メリット
- Flutterネイティブのスクロール検知機能を活用
- PDFの表示が高品質
- シンプルな実装

#### デメリット
- `PdfPreview`ウィジェットのスクロールイベントが期待通りに取得できない可能性
- PDF生成とプレビューの処理が重い場合がある
- カスタマイズが限定的

#### 使用場面
- PDF形式の利用規約を表示する場合
- 印刷機能も必要な場合

### 2. flutter_inappwebview

#### 実装方法
- JavaScriptのスクロールイベントを監視
- `window.addEventListener('scroll', ...)`でスクロール検知
- `addJavaScriptHandler`でFlutterとJavaScript間の通信

#### メリット
- 高精度なスクロール進捗を取得可能
- JavaScriptによる柔軟なカスタマイズ
- リアルタイムでスクロール状況を監視
- 豊富なWebView機能

#### デメリット
- JavaScriptの知識が必要
- 実装が複雑
- パッケージサイズが大きい

#### 使用場面
- Webベースのコンテンツでスクロール検知が必要
- 高機能なWebView機能が必要
- カスタマイズ性を重視する場合

### 3. webview_flutter

#### 実装方法
- JavaScriptChannelを使用してFlutterとJavaScript間で通信
- `addJavaScriptChannel`でメッセージ受信
- JavaScriptでスクロールイベントを監視

#### メリット
- 公式パッケージのため安定性が高い
- シンプルなAPI
- 軽量

#### デメリット
- JavaScript通信のAPIが限定的
- flutter_inappwebviewと比較して機能が少ない

#### 使用場面
- 基本的なWebView機能で十分な場合
- 軽量なWebViewが必要
- 公式パッケージを優先する場合

## 推奨実装方法

### 利用規約表示の用途別推奨

1. **PDF形式の利用規約表示**
   - 推奨: `flutter_inappwebview`または`webview_flutter`でHTML形式として表示
   - 理由: PDFプレビューのスクロール検知は技術的制約がある

2. **HTML形式の利用規約表示**
   - 推奨: `flutter_inappwebview`
   - 理由: 高精度なスクロール検知とリアルタイム進捗表示が可能

3. **軽量実装が必要な場合**
   - 推奨: `webview_flutter`
   - 理由: 公式パッケージで軽量、基本的なスクロール検知が可能

## 実装上の注意点

### 共通事項
- スクロール完了の判定は95%以上を推奨（100%は到達困難な場合がある）
- ユーザーの操作性を損なわないUI設計
- 進捗表示によるユーザビリティ向上

### セキュリティ
- JavaScriptを使用する場合は適切なサニタイゼーション
- 信頼できるコンテンツのみ表示

### パフォーマンス
- 大容量PDFの場合は遅延読み込みを検討
- スクロールイベントの頻度制限

## 結論

利用規約の表示とスクロール検知においては、`flutter_inappwebview`を使用したHTML形式での表示が最も適している。理由は以下の通り：

1. **高精度な検知**: JavaScriptによるリアルタイムスクロール監視
2. **ユーザー体験**: 進捗表示によるフィードバック
3. **柔軟性**: カスタマイズ可能な表示とイベント処理
4. **実装の安定性**: WebViewのスクロールイベントは信頼性が高い

PDFの場合も、HTMLに変換してWebViewで表示することで、同様の検知機能を実現できる。